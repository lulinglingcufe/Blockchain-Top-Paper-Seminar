Hijacking Bitcoin:Routing Attacks on Cryptocurrencies
AS 自治系统
Internet由大量的独立网络或自治系统AS Autonomous System构成。
并由不同的组织运营，这些组织通常是公司、大学或ISP。
Internet采用的域间路由协议是边界网关协议（BGP，border gateway protocol）。
prefix前缀   如果前缀包含2的8次方个地址，/24 表示留下24位给网络部分
multihoming 多寻址


各位同学好，今天我要讲的论文是 S&P 2017上的
Hijacking Bitcoin:Routing Attacks on Cryptocurrencies
针对Bitcoin的路由攻击


我们经常可以在新闻上看到Routing attacks这种攻击。
17年的时候，曾经发生Visa，Mastercard还有赛门铁克的一些通信traffic被BGP攻击操纵了
怀疑是受到俄罗斯政府控制的电信节点的攻击。
大概是在7分钟内的时间，这些通信被该电信节点声明所有。

在14年的时候，曾经有黑客控制19个Internet服务提供商，
通过BGP攻击来操纵比特币矿池，使得挖矿的收益归黑客所有。
每次攻击大概只有30s。造成了$83,000 美元的损失。

但这仅仅是路由攻击的冰山一角。
作者的团队通过6个月分析BGP数据发现当今互联网中的BGP劫持还是比较普遍的。

这张图，横坐标是月份，纵坐标是该月发生BGP劫持的数量。
当然很多劫持不是恶意的，是由错误配置导致的。
但我们认为BGP攻击是可行的，而且实际上影响了Internet 通信
这篇文章主要研究路由攻击对于Bitcoin的影响

理论上Bitcoin应该是去中心化的，可以防止路由攻击

因为Bitcoin节点分布在全球，它建立随机连接，使用了多寻址和额外的中继网络
但实际上从路由和挖矿的角度来看，Bitcoin还是比较中心化的。
为什么这么说呢。看下面这张图。
纵坐标是挖矿算力的累计百分比
横坐标是相应的托管网络的数量
托管网络就相当于一个代理吧
可以看到68%的算力托管于10个网络

还有下面这张图的纵坐标是Bitcoin 连接的累计百分比
横坐标是可以拦截这些连接的传输网络的数量
3个传输网络就可以拦截超过百分之60的Bitcoin连接。

由于这些特点，当前有两种路由攻击是可行且有效的。
一种是分割攻击，攻击者可以将整个网络分割成两半。
另一种是延迟攻击，攻击者可以延迟区块的广播。

分割攻击是可见的，因为攻击者首先需要劫持IP地址的一些前缀，
但这种攻击方式对于整个Bitcoin网络都是有效的。
延迟攻击则是完全不可见的，因为攻击者只是修改了一些节点之间的通信
它只对目标节点有效。               

首先介绍BGP和Bitcoin的背景
然后具体分析分割攻击和延迟攻击
最后提出建议

Bitcoin是一个分布式网络，节点之间随机地建立连接。
每个节点都保存记录所有交易的账本——区块链
区块链是由矿工来增加的
一个矿池会聚集多个矿工
Bitcoin连接是在Internet中路由的

Internet由大量的独立网络或自治系统AS Autonomous System构成。
它们由不同的组织运营，这些组织通常是公司、大学或ISP。
Internet采用的域间路由协议是边界网关协议（BGP，border gateway protocol）。
它可以计算转发路径

在广播Bitcoin消息的时候没有进行完整性检验，也没有加密
因此转发路径上的任何AS都可以延迟、丢弃或修改该数据。
这里就算Bitcoin 消息被加密了，AS也可以识别或丢弃消息。

下面介绍分割攻击
分割攻击的目标是将Bitcoin网络分割成两个脱节的部分。
这两个部分之间无法进行信息交互。

这种攻击的危害很大
首先会造成拒绝服务。因为交易无法被广播了。
其次会造成收益损失，因为某个脱节部分中计算出的链将被丢弃
最后在分割期间一个Bitcoin可以被花两次，就是双花攻击。
下面来看它的原理

假设中间的AS是一个恶意攻击者。它想把Bitcoin网络分割成左右两块。

攻击者需要截获所有从左边到右边部分的通信。

我们关注F节点来看具体如何操作。

攻击者需要通过BGP劫持 吸引所有目的地是F的通信  
F有一个属于它提供商AS6的IP地址。AS6需要告诉Internet一个地址前缀，
包含AS6拥有的IP地址。

AS6会创建一个BGP广播。它由一个AS广播到另一个AS去。直到所有AS都学习到前往目标前缀的路径。

比如AS1会知道通过AS7前往AS6。

由于BGP不检查广播的有效性。因此任何AS都可以广播任意前缀。

我们假设攻击者广播了包含绿色节点IP的前缀。

由于攻击者的广播更具体，网络部分的长度有24位。
Internet上的路由偏向于最长的前缀匹配，因此实际上会使用恶意的广播。

因此所有去往绿色节点的通信都会被攻击者转发

通过劫持右侧节点所属的IP前缀，攻击者可以截获所有的连接

一旦劫持成功，攻击者可以切断两侧的连接造成分割

当然实际上分割不是那么简单的。有的连接是无法拦截的。

有三种无法拦截的连接。矿池中的连接，AS内部的连接和有秘密协议的矿池间的连接。

即便如此，攻击者也可以探测并定位这些连接，剔除不可能分割的节点后再进行分割。

文章中给出了一个算法。
给定希望从网络中分割出去的节点集合，存在攻击者可以分割的唯一最大节点子集。

文章从可行性和时间有效性方面评估分割攻击。   
首先需要推断实际的Bitcoin拓扑结构和路由信息。

文章发现通过劫持少于100个前缀就可以将Bitcoin的算力一分为二。

和已经观察到的每天发生的劫持相比，100个前缀是很少的。

为了说明这一点，我们来看下面这张图。
下面这张图的横坐标是月份，纵坐标是一次攻击中最多劫持的前缀的数量。
劫持超过1000个前缀在当前的Internet中是相当常见的。

通过攻击自己的Bitcoin节点，来测量实现分割攻击需要的时间。

作者通过ETH 就是 苏黎世联邦理工学院 作者的科研单位
运行一些Bitcoin节点
通过Amsterdam的一个AS来广播它的前缀。然后连接到真实的Bitcoin网络中。

一开始所有到节点的traffic都是通过Amsterdam传输的。

然后用Cornell的一个AS劫持节点的前缀，

文章测量了该恶意AS将所有traffic转移需要的时间

y轴是累计拦截连接的百分比，x轴是时间。
只需要不到2分钟就可以拦截所有连接。

但是需要花数个小时的时间来消除影响。

谷歌在08年的时候，用了3个小时来缓解一次大型的劫持攻击。
这是一个人为驱动的过程。

下面介绍延迟攻击。 

延迟攻击的目的是使得受害者无法收到最新的区块。

受害者不同，延迟攻击造成的危害也不同。
如果是商家的话，他容易受到双花攻击的影响。
对于矿池，他可能将算力浪费在注定要丢弃的链上。
对于普通节点，他可能无法连接到P2P网络中。

这张图上有3个Bitcoin节点，目标节点和AB节点相连接。

攻击者可以拦截节点A和目标节点间的traffic。
它希望延迟对于受害者的区块广播。

现在有一个新的区块被挖出来了，A和B都知道了这个新区块，它们想通过INV消息，把新区块传给受害者。

但是目标节点只会向它的一个邻居比如说A，通过GET DATA消息请求区块。
这是Bitcoin协议规定的。

如果攻击者想防止目标节点获取该新区块。
攻击者可以丢弃GET DATA消息。

也可以将A返回来的区块给丢弃掉。

但是实际上没有那么简单。因为Bitcoin基于一个可靠的协议栈TCP。
如果特定的数据包没有正常发送，那么连接就会断开。

但是攻击者可以拦截GET DATA消息，并修改其内容。

修改请求区块的ID，使得节点A发送一个旧块给受害者。

这样做不会使受害者产生错误信息。

然后受害者会等待20分钟，等节点A把真正的区块被发送过来。

攻击到这里为止，使得受害者在20分钟的间隔内，无法获得最新的区块。
这已经是一个很大的时间段了，因为Bitcoin10分钟出一个块。

在超时了20分钟之后，受害者会认为节点A是恶意的，然后将断开和它的连接。

如果攻击者想保持连接，那么他就需要修改一个本来是请求交易的GET DATA消息。
让它来请求区块。

如果区块在这段20分钟超时之前到达。那么这次攻击就是隐形的。连接可以保持，后续还可以使用。

也是从有效性和可行性两个方面来评估延迟攻击

为了评估有效性，文章部署了真实的Bitcoin节点，它将连接到真实的Bitcoin网络中。
假设只有一部分的连接会被攻击者劫持。

实验结果表明，受害者在连接到网络的大部分时间都无法及时接收到最新块。

即便攻击者仅仅截获了一部分的节点连接

如果攻击者截获了50%的连接。

受害者在60%的运行时间里都无法接收到最新块。

对于可行性来说，文章分析了当前的Bitcoin网络，70%的节点都是易受攻击的。
它们至少可以被上述的一种路由攻击影响。
而且作者还没有考虑节点的直接Internet服务商为潜在攻击者。

最后作者提供了一些对策，包括长期和短期的。

短期的对策现在就可以部署，但是并非那么有效。
比如Bitcoin节点在选择其邻接节点的时候，考虑更多路由的因素。
不要被同一个ISP网络服务提供商拦截连接。这可以降低延迟攻击发生的概率。
相同的思路，节点应该注意它邻居节点的行为，
比如异常的消息延迟增加，也许意味着分割攻击的出现。

另一方面，长期的对策需要协议或者基础设置的改变，但是更加有效。
比如端到端的加密，可以防止延迟攻击，但是不能防止分割攻击。
部署安全的BGP路由协议，可以防止分割攻击，但是不能防止延迟攻击。

总结一下，当前的Bitcoin易受路由攻击。这种攻击的影响还是比较大的。
有一些对策，现在进行部署也是非常可行的。
